name: Deploy to Oracle Cloud ARM

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: deploy-to-oci
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.24.0'

      - name: Build project
        run: go build ./...

      - name: Run tests
        run: go test ./...

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install Docker on OCI (if missing)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            set -e
            if ! command -v docker &> /dev/null
            then
              if command -v dnf &> /dev/null
              then
                # Oracle Linux / RHEL / CentOS
                sudo dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
                sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
                sudo systemctl start docker
                sudo systemctl enable docker
              elif command -v apt-get &> /dev/null
              then
                # Ubuntu / Debian
                sudo apt-get update
                sudo apt-get install -y ca-certificates curl gnupg
                sudo install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                sudo chmod a+r /etc/apt/keyrings/docker.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                sudo apt-get update
                sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              fi
              sudo usermod -aG docker $USER
            fi
            
            # Ensure docker compose is available (newer versions use 'docker compose')
            if ! docker compose version &> /dev/null
            then
              echo "Installing docker-compose-plugin..."
              if command -v dnf &> /dev/null; then sudo dnf install -y docker-compose-plugin; fi
              if command -v apt-get &> /dev/null; then sudo apt-get install -y docker-compose-plugin; fi
            fi
          EOF

      - name: Clone and Deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            set -e
            PROJECT_DIR="/home/${{ secrets.OCI_USER }}/go-dutch"
            
            if [ -d "$PROJECT_DIR" ]; then
              cd "$PROJECT_DIR"
              # Ensure we are on the main branch and pull latest changes
              git fetch origin main
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }}.git "$PROJECT_DIR"
              cd "$PROJECT_DIR"
            fi
            
            # Create .env file for Docker Compose
            echo "APP_GODUTCH_STAGE=production" > .env
            echo "APP_GODUTCH_DEBUG=false" >> .env
            echo "APP_GODUTCH_SERVERPORT=8080" >> .env
            echo "APP_GODUTCH_DBUSERNAME=postgres" >> .env
            echo "APP_GODUTCH_DBPASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "APP_GODUTCH_DBHOST=db" >> .env
            echo "APP_GODUTCH_DBPORT=5432" >> .env
            echo "APP_GODUTCH_DBDEFAULTNAME=godutch" >> .env
            echo "APP_GODUTCH_JWTSECRET=${{ secrets.JWT_SECRET }}" >> .env
            
            # Run docker compose
            docker compose up -d --build
            
            # Run migrations
            # We use the app container to run migrations if the app has a migration command,
            # but based on the previous workflow, it was using a separate migrate container.
            # Using the same network as defined in docker-compose.yml
            docker run --rm -v $(pwd)/migrations:/migrations --network go-dutch_default migrate/migrate \
              -path=/migrations/ \
              -database "postgres://postgres:${{ secrets.DB_PASSWORD }}@db:5432/godutch?sslmode=disable" up
            
            # Cleanup unused images
            docker image prune -f
          EOF